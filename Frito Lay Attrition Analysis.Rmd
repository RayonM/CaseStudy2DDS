---
title: "Frito Lay Analysis"
author: "Rayon M"
date: "7/30/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## **Project Objectives**

  1.  Classify Attrition
  2.  Identify Trends within the Departments and Job Roles
  3.  Predict Monthly Income

## **Methodology**

  This Analysis was conducted using the following methodology:
  
  1.  Loaded the data set provided (CaseStudy2-data.csv)
  2.  Performed Exploratory Data Analysis to identify key factors that leads to Attrition, and find explanatory variables for the Linear Regression Model.
  3.  Used the Naive Bayes to achieve Classification
  4.  Used Linear Regression to Predict the Monthly Income

  Categorical Data:
  
  *  Attrition
  *  BusinessTravel
  *  Department
  *  EducationField
  *  Gender
  *  JobRole
  *  MaritalStatus
  *  Over18
  *  OverTime
  
  
  Continuous Variables:
  
  *  Age
  *  DailyRate
  *  DistanceFromHome
  *  Education
  *  EmployeeCount
  *  EmployeeNumber
  *  EnvironmentSatisfaction
  *  HourlyRate
  *  JobInvolvement
  *  JobLevel
  *  JobSatisfaction
  *  MonthlyIncome
  *  MonthlyRate
  *  NumCompaniesWorked
  *  PercentSalaryHike
  *  PerformanceRating
  *  RelationshipSatisfaction
  *  StandardHours
  *  StockOptionLevel
  *  TotalWorkingYears
  *  TrainingTimesLastYear
  *  WorkLifeBalance
  *  YearsAtCompany
  *  YearsInCurrentRole
  *  YearsSinceLastPromotion
  *  YearsWithCurrManager


```{r echo = FALSE}

# Import the relevant packages  Libraries Used in the Study

library(tidyverse)
library(GGally)
library(naniar)
library(dplyr)
library(class)
library(caret)
library(e1071)
library(ggplot2)
library(plotly)
library(data.table)
library(ggthemes)
library(lessR)
#install.packages("scales")
library(scales)

```


```{r echo = FALSE}
# Read in the employee dataset that will be used in the Analysis.

employee_data = read.csv("C:/Users/Rayon/OneDrive/Documents/Doing DataScience/Doing Data Science/MSDS_6306_Doing-Data-Science/Unit 14 and 15 Case Study 2/CaseStudy2-data.csv")

```

## **Exploratory Data Analysis (EDA)**
###  Explore variables that can predict Attrition
###  Look for patterns in the data

```{r}
# Look at the structure of the data
str(employee_data)

# reveals top 6 observations in the data
head(employee_data)
# 870 observations and 36 variables

# view the variables in the dataset to determine if there are any "NAs" or missing values.
gg_miss_var(employee_data)

# The dataset did not have any missing  or NA values. 

```

# What trends exist within the data? What is the split between Attrition Yes and No?

```{r}

attriton_split <- data.frame(employee_data %>% group_by(Attrition) %>% summarise(Count = n()))
attriton_split

# The variable "Attrition" contains 730 No and 140 Yes observations in the dataset.

# Calculate the percentage difference of the No vs. Yes observations.
# Use setDT from the data.table package to calculate the %

setDT (employee_data)[, 100* .N/ nrow(employee_data), by = Attrition]
BarChart(Attrition, fill = (count) , data = employee_data)

#Plot(Attrition, data = employee_data)
# The data is consist of 84% No and 16% Yes as it relates to Attrition
# Attrition happens 16% of the time.


```

#  Find where Attrition is highest among the Categorical Variables

```{r}

# Attrition vs. Overtime
attrition_overtime <- ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = OverTime, colour = Attrition))+
  theme_economist()
  ggplotly(attrition_overtime)

employee_data %>% count(Attrition, OverTime)

# 29% of all employees did Overtime
# 71% of all employees did not do Overtime

attrition_overtime2 <-  employee_data %>% 
  count(Attrition, OverTime)%>%
  ggplot(mapping = aes(x = Attrition,  y = OverTime)) +
  geom_tile(mapping = aes(fill = n))
  ggplotly(attrition_overtime2)

# 57% of persons who left the company were working overtime! This will be one of the factors that leads to Attrition


```


```{r}
# Attrition vs BusinessTravel
attrition_businesstravel <- ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = BusinessTravel, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. Business Travel")
  ggplotly(attrition_businesstravel)

employee_data %>% count(Attrition, BusinessTravel)

# 15% of employees that traveled Rarely left the company
# 12% of employees that were Non-Travel left the company
# 22% of employees that were Travel_Frequently left the company

attrition_businesstravel2 <-  employee_data %>% 
  count(Attrition, BusinessTravel)%>%
  ggplot(mapping = aes(x = Attrition,  y = BusinessTravel)) +
  geom_tile(mapping = aes(fill = n))
  ggplotly(attrition_businesstravel2)
  
# The Highest Attrition percentage was from those who Traveled rarely - 22%. Hence, I don't think business Travel is a factor for Attrition.
  
```  
  
  
```{r}
# Attrition vs Department

attrition_department <- ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = Department, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. Department")
  
  ggplotly(attrition_department)

employee_data %>% count(Attrition, Department)

# 17% of those that left were from the Human Resources Department
# 13% of those that left were from the Research & Development Department
# 21% of that that left were from the Sales Department

attrition_department2 <-  employee_data %>% 
  count(Attrition, Department)%>%
  ggplot(mapping = aes(x = Attrition,  y = Department)) +
  geom_tile(mapping = aes(fill = n))+
    theme_economist()+
  ggtitle("Attrition vs. Department")

  ggplotly(attrition_department2)
  
# Do sales people work more overtime?
  
  ggplotly(ggplot(data = employee_data)+
    geom_bar(mapping = aes(x = Department, fill = OverTime, alpha = JobRole), position = "dodge") +
    ggtitle("Overtime by Department")+
    xlab("Department")+
    ylab("Count"))

# No. There is a higher percentage of people working overtime in the Research and Development Department - 29%
  #65% of Overtime comes from the Research & Development Department
  #32% of Overtime comes from the Sales Department

PieChart(Department, data = employee_data, hole = 0)

# The Research and Development Department makes up 65% of the company. Department is one of the Factors


#What is the percentage of non-exempt people leaving the company versus full time?


```


```{r}
# Attrition v. EducationField

ggplotly(ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = EducationField, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. EducationField"))

employee_data %>% count(Attrition, EducationField)  


```


```{r}
# Attrition v. Gender

ggplotly(ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = Gender, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. Gender"))

employee_data %>% count(Attrition, Gender)


```


```{r}
# Attrition v. JobRole

ggplotly(ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = JobRole, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. JobRole"))

employee_data %>% count(Attrition, JobRole)  



```


```{r}
# Attrition v. MaritalStatus

ggplotly(ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = MaritalStatus, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. MaritalStatus"))

employee_data %>% count(Attrition, MaritalStatus)

# Higher Attrition count among Single people


```


```{r}
# Attrition v. Over18
ggplotly(ggplot(data = employee_data) + 
  geom_count(mapping = aes(x = Attrition, y = Over18, colour = Attrition))+
  theme_economist()+
  ggtitle("Attrition vs. Over18"))


# No significance to the Study. All observations are over18.
```
  
  
# Find where Attrition is highest among the Continuous variables


```{r}

ggplot(data = employee_data, mapping = aes(x= Attrition,  group = JobLevel)) +
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="workclass") +
    facet_grid(~MonthlyIncome) +
    scale_y_continuous(labels = scales::percent)+coord_flip()+theme(legend.position = "none")



```




# **Classification Model**
## Naive Bayes

```{r}

# Find the average accuracy, sensitivity, and specificity of the model. The sensitivity and specificity must both be above 60%.

master_acc = numeric(100)
master_sensitivity = numeric(100)
master_specificivity = numeric(100)
master_seed = numeric(100)


for(seed in 1:100)
{
  set.seed(seed)
  splitPerc = 0.75
  TrainIndices = sample(1:dim(employee_data)[1],round(splitPerc * dim(employee_data)[1]))
  Train = employee_data[TrainIndices,]
  Test = employee_data[-TrainIndices,]
  model_attrition_yesorno = naiveBayes(Train[,c("Age", "JobLevel", "MonthlyIncome", "OverTime", "MaritalStatus", "Gender")],factor(Train$Attrition, labels=c("No", "Yes")))
  CM = confusionMatrix(table(factor(Test$Attrition, labels = c("No", "Yes")), predict(model_attrition_yesorno,Test[,c("Age", "JobLevel", "MonthlyIncome", "OverTime", "MaritalStatus", "Gender")])))
  master_acc[seed] = CM$overall[1]
  master_sensitivity[seed] = CM$byClass[1]
  master_specificivity[seed] = CM$byClass[2]
  master_seed[seed] = seed
}

mean(master_seed)
mean(master_acc)
mean(master_sensitivity)
mean(master_specificivity)


# The mean Accuracy is 0.8544061
# The mean Sensitivity is 0.8688525
# The mean Specificity is 0.6470588

```



## Competition dataset with No Attrition. Use the Naive Bayes Model to predict Attrition.

```{r echo = FALSE}
#Load in the competition dataset
comp_dataset = read.csv("C:/Users/Rayon/OneDrive/Documents/Doing DataScience/Doing Data Science/MSDS_6306_Doing-Data-Science/Unit 14 and 15 Case Study 2/CaseStudy2CompSet No Attrition.csv")

#Use the Naive Bayes Classification Model to classify each observation as Yes or No to Attrition.
# Model name = "model_attrition_yesorno"

comp_dataset$Attrition =  predict(model_attrition_yesorno,comp_dataset[,c("Age", "JobLevel", "MonthlyIncome", "OverTime")])

view(comp_dataset)

write.csv(comp_dataset, "Case2PredictionsMorris Attrition.csv")

```


## Exploratory Data Analysis for Regression Model

```{r}
# Plot the following variables to see the correlation with MonthlyIncome

employee_data %>% select(MonthlyIncome, Age, Department, EducationField, JobLevel, JobRole, TotalWorkingYears, YearsAtCompany) %>%
ggpairs()

```



## Regression Model to predict Monthly Income
```{r}

# Goal: create a regression model that has an RMSE less than $3000

# Dependent Variable: MonthlyIncome
# Predictors/Experiment variable(s): Age and Total Working Years


numMSPEs = 1000

MSPEHolderModel4 = numeric(numMSPEs)
MSPEHolderModel5 = numeric(numMSPEs)
MSPEHolderModel10 = numeric(numMSPEs)

for (i in 1:numMSPEs)
{
  
  index <- createDataPartition(employee_data$ID, p = .60, list = FALSE)
  monthly_income_train <- employee_data[index, ]
  monthly_income_test <- employee_data[-index, ]
  
  
  #Model 4
  monthly_income_model_fit4 = lm(MonthlyIncome ~ JobLevel, data = monthly_income_train)
  monthly_income_Pred_4 = predict(monthly_income_model_fit4, newdata = monthly_income_test)
  MSPE4 = mean((employee_data$MonthlyIncome - monthly_income_Pred_4)^2)
  MSPE4
  MSPEHolderModel4[i] = MSPE4
  
  #Model 5
  monthly_income_model_fit5 = lm(MonthlyIncome ~ JobRole, data = monthly_income_train)
  monthly_income_Pred_5 = predict(monthly_income_model_fit5, newdata = monthly_income_test)
  MSPE5 = mean((employee_data$MonthlyIncome - monthly_income_Pred_5)^2)
  MSPE5
  MSPEHolderModel5[i] = MSPE5
  

}


mean(MSPEHolderModel4)
summary(monthly_income_model_fit4)
confint(monthly_income_model_fit4)

mean(MSPEHolderModel5)
summary(monthly_income_model_fit5)
confint(monthly_income_model_fit5)


testMSE4 = mean((monthly_income_test$MonthlyIncome - monthly_income_Pred_4) ^ 2)
testMSE4
RMSE4 <- sqrt(testMSE4)
RMSE4

testMSE5 = mean((monthly_income_test$MonthlyIncome - monthly_income_Pred_5) ^ 2)
testMSE5
RMSE5 <- sqrt(testMSE5)
RMSE5


```

## Competition dataset with No MonthlyIncome. Use the Linear Regression Model to predict Monthly Income.

```{r}
# #Load in the competition dataset
# monthly_income_comp_dataset = read.csv("C:/Users/Rayon/OneDrive/Documents/Doing DataScience/Doing Data Science/MSDS_6306_Doing-Data-Science/Unit 14 and 15 Case Study 2/CaseStudy2CompSet No Salary.csv")
# 
# #Use the Linear Regression Model to predict the MonthlyIncome for each observation.
# # Model name = "model_attrition_yesorno"
# 
# #monthly_income_comp_dataset$PredMonthlyIncome =  predict(model_attrition_yesorno,comp_dataset[,c("Age", "JobLevel", "MonthlyIncome", "OverTime")])
# 
# #view(monthly_income_comp_dataset)
# 
# #write.csv(monthly_income_comp_dataset, "Case2PredictionsMorris Salary.csv")

```



# Summary of the Models

```{r}


# 
# monthly_income_test %>% ggplot(aes(x = MonthlyIncome, y = TotalWorkingYears)) + 
#   geom_point() +
#   geom_line(data = monthly_income_test, aes( x = MonthlyIncome, y = monthly_income_Pred_6, col = "red"))
# 
# 
# 
# monthly_income_test %>% ggplot(mapping = aes(x = MonthlyIncome, y = TotalWorkingYears))+ 
#   geom_point()+
#   geom_smooth(method = "lm", se = FALSE)
# 
# monthly_income_test %>% ggplot(mapping = aes(x = MonthlyIncome, y = TotalWorkingYears))+ 
#   geom_point()+
#   geom_line(colour = "red")+
#   geom_smooth(method = "lm", se = FALSE)
# 
# 
# monthly_income_test_mutate %>% ggplot(mapping = aes(x = MonthlyIncome, y = TotalWorkingYears))+ 
#   geom_point()+
#   geom_line(colour = "red")+
#   geom_smooth(method = "lm", se = FALSE)

```


```{r}
employee_data %>% ggplot(mapping = aes(x = MonthlyIncome, y = Department))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")
#cor.test(employee_data$MonthlyIncome, as.factor(employee_data$Department))


employee_data %>% ggplot(mapping = aes(x = MonthlyIncome, y = Age))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")


employee_data %>% ggplot(mapping = aes(x = MonthlyIncome, y = EducationField))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")+
  coord_flip()

employee_data %>% ggplot(mapping = aes(x = MonthlyIncome, y = JobLevel))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")
cor.test(employee_data$MonthlyIncome, employee_data$JobLevel)


employee_data %>% ggplot(mapping = aes(x = MonthlyIncome, y = JobRole))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")+
  coord_flip()

str(employee_data)

cor.test(employee_data$MonthlyIncome, employee_data$YearsAtCompany)

employee_data %>% ggplot(mapping = aes(x = TotalWorkingYears, y = YearsAtCompany, position = "jitters"), position = "jitters")+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")


cor.test(employee_data$MonthlyIncome, employee_data$TotalWorkingYears)

employee_data %>% ggplot(mapping = aes(x = TotalWorkingYears, y = MonthlyIncome))+
  geom_point()+
  geom_smooth(method = "lm" , se = FALSE)+
  ggtitle("Total Years vs. MonthlyIncome")+
  coord_flip()



```


```{r}
# Code on how to break out the training and test data set.

# index <- createDataPartition(adult$Class, p = .70, list = FALSE)
# train <- adult[index, ]
# test <- adult[-index, ]

```

```{r}

employee_data %>% select(Attrition,
 ) %>%
  ggpairs(mapping = aes(color = Attrition))

# Age - potential
# Attrition - throw away
# BusinessTravel - throw away
# DailyRate - throw away
# Department potential
# DistanceFromHome - throw away
# Education - throw away
# EducationField  - potential
# EmployeeCount - throw away
# EmployeeNumber - throw awy
# EnvironmentSatisfaction - Throw away
# Gender - Throw away
# HourlyRate - Throw away
# JobInvolvement - throw away
# JobLevel - potential
# JobRole - potential
# JobSatisfaction - Throw away
# MaritalStatus - throw away
# MonthlyIncome
# MonthlyRate - throw away
# NumCompaniesWorked - throw away
# Over18 - throw away
# OverTime - throw away
# PercentSalaryHike - Throw away
# PerformanceRating - throw away
# RelationshipSatisfaction - Throw away
# StandardHours - throw away
# StockOptionLevel - throw away
# TotalWorkingYears - High potential
# TrainingTimesLastYear - Throw away
# WorkLifeBalance - Throw away
# YearsAtCompany - slight potential
# YearsInCurrentRole  - throw away
# YearsSinceLastPromotion - throw away
# YearsWithCurrManager - throw away


```



#EDA CHUNK
```{r}

# To examine the distribution of a CATEGORICAL variable, use a bar chart
# You can compute these values manually with dplyr::count()
# To examine the distribution of a continuous variable, use a histogram:
# You can compute this by hand by combining dplyr::count() and ggplot2::cut_width():
# Look at overtime and numberofcompanies worked.. there may be a trend there.Why is the average lower for one versus the other.
# Look at the YearswithcurrentManager and YearsatCompany.. something there
# Yearswithcurrentmanager and YearsSinceLastPromotion
# Yearsincurrentrole and YearsSinceLastPromotion


# employee_data %>% select(MonthlyIncome
#   ,JobSatisfaction
#   ,Age
#   ,MaritalStatus          
#   ,MonthlyRate
#   ,NumCompaniesWorked
#   ,Gender
#   ,HourlyRate
#   ,JobInvolvement          
#   ,JobLevel                
#   ,JobRole
#   ,Education               
#   ,EducationField          
#   ,EmployeeCount           
#   ,EmployeeNumber          
#   ,EnvironmentSatisfaction ) %>%
#   ggpairs(mapping = aes(color = Attrition))






ggplot(data = employee_data, mapping = aes(x = MonthlyIncome, y = MonthlyIncome, colour = Attrition)) +
  geom_area()



ggplot(data = employee_data, mapping = aes(x = MonthlyIncome, colour = JobRole)) +
  geom_freqpoly()

# Observation, the people with salary less than $5,000 is greatest among the Research and Development Department, why?
# Are they younger?, Do they have lower job levels, do they work less hours? Did more people leave the company out of the Research & Development department? What department had the highest Attrition?


# Research Scientist are the highest among those making less than $5,000. They start out a little higher than other roles. but only less than 5 are making over $10,000 
ggplot(data = employee_data, mapping = aes(x = MonthlyIncome, colour = JobRole)) +
  geom_freqpoly()
 
employee_data %>% group_by(JobRole) %>% count(MonthlyIncome)

# Monthly Income
ggplot(data = employee_data, mapping = aes(x= JobRole, y = MonthlyIncome, color = Attrition))+
  geom_boxplot()

#How does overtime affect this? 
ggplot(data = employee_data, mapping = aes(x= JobRole, y = MonthlyIncome, color = OverTime))+
  geom_boxplot()

#How many people get overtime by jobrole? Only 65 research scientist gets overtime.
employee_data %>% group_by(JobRole) %>% count(OverTime)


# What does this look like for the daily rate?
ggplot(data = employee_data, mapping = aes(x= JobRole, y = DailyRate, color = Attrition))+
  geom_boxplot()

# What does this look like for the Monthly rate?
ggplot(data = employee_data, mapping = aes(x= JobRole, y = MonthlyRate, color = Attrition))+
  geom_boxplot()


# Attrition is high among those who make less that 5,000. The graph below shows this.
ggplot(data = employee_data, mapping = aes(x = MonthlyIncome, colour = Attrition)) +
  geom_freqpoly()

# The average monthlyIncome was significantly lower in one Education Field than the others? Why?
# The average monthlyIncome was significantly lower in one Department than the others? Why?


ggplot(data = )
ggplot(data = employee_data, mapping = aes(x= EducationField, y = MonthlyRate, color = Attrition))+
  geom_boxplot()

```




# % Experimentation
```{r}

# library( data.table )
# setDT( students )[ , 100 * .N / nrow( students ), by = gender ]
# 
# setDT(employee_data)[, 100* .N/nrow(employee_data), by = Attrition]
# 
# 
# library( dplyr )
# employee_data %>% 
#     group_by( Attrition ) %>% 
#     summarise( percent = 100 * n() / nrow( employee_data ) )
# 
# view(employee_data)

```

